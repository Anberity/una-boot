<!DOCTYPE html>
<html lang="ch">
<head>
    <title>使用 SOFAStack 快速构建微服务 · SOFAStack</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="SOFAStack is a Scalable Open Financial Architecture for building cloud native applications" />
    <meta name="generator" content="Hugo 0.55.5" />
    <link rel="shortcut icon" href="image/favicon.png" type="image/png">

    <link href="css/base-min.css" rel="stylesheet">



    <link href="css/main.css" rel="stylesheet">
    <link href="css/zoom-image.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.css" rel="stylesheet"/>
    <script src="js/iconfont.js"></script>
    <script src="js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>window.SITE_LANGUAGE = "zh"</script>
    <script src="js/app.js"></script>
    <script type="application/javascript">
        var doNotTrack = false;
        if (!doNotTrack) {
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-142131411-1', 'auto');

            ga('send', 'pageview');
        }
    </script>

</head>

<body>
<header class="ss-header">
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="logo-link" href="./index.html">
                <img class="logo" src="image/logo.svg">
            </a>
            <div class="-show-mobile">
                <a id="mobile-menu-icon">
                    <svg class="icon" aria-hidden="true">
                        <use xlink:href="#icon-menu"></use>
                    </svg>
                </a>
                <nav id="mobile-menu">
                    <div id="js-menu-search-mobile" class="navbar-search-mobile">
                        <input class="input" placeholder="请输入要搜索的关键词">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-search"></use>
                        </svg>
                    </div>
                    <a class="" href="/projects/">
                        <span>项目</span>
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-ARROW"></use>
                        </svg>
                    </a>
                    <a class="" href="/guides/">
                        <span> 指南</span>
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-ARROW"></use>
                        </svg>
                    </a>
                    <a class="" href="/blog/">
                        <span>博客</span>
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-ARROW"></use>
                        </svg>
                    </a>
                    <a class="" href="/activities/">
                        <span>活动</span>
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-ARROW"></use>
                        </svg>
                    </a>
                    <a class="" href="/awesome/">
                        <span>关于我</span>
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-ARROW"></use>
                        </svg>
                    </a>
                    <a href="/en/">
                        <span>English</span>
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-transfer"></use>
                        </svg>
                    </a>
                </nav>
            </div>
        </div>
        <div class="navbar-menu -hidden-mobile">
            <div class="navbar-start">
                <a class="navbar-item " href="/projects/">项目</a>
                <a class="navbar-item " href="/guides/">指南</a>
                <a class="navbar-item " href="/blog/">博客</a>
                <a class="navbar-item " href="/activities/">活动</a>
                <a class="navbar-item " href="/awesome/">关于我</a>
            </div>
            <div class="navbar-end">
                <div class="navbar-item">
                    <div id="js-menu-search" class="navbar-search">
                        <input class="input" placeholder="请输入要搜索的关键词">
                        <svg class="icon" aria-hidden="true">
                            <use xlink:href="#icon-search"></use>
                        </svg>
                    </div>
                </div>
                <div class="navbar-item">
                    <a class="translation" href="/en/">En</a>
                </div>
            </div>
        </div>
    </nav>
</header>
<div class="ss-layout-container">
    <main class="ss-layout-main -card">
        <div class="ss-meta">
            <h1 class="title">
                使用 SOFAStack 快速构建微服务
            </h1>
            <div class="meta"></div>
        </div>
        <article class="typo">
            <p><strong>注意：您需要自行部署后端环境依赖，并修改示例中的服务依赖地址即可使用。</strong></p>

            <h2 id="实验内容">实验内容</h2>

            <p>本实验基于 SOFAStack 快速构建一个微服务，主要包括以下几个部分：</p>

            <ul>
                <li>使用 SOFABoot + SOFARPC 发布服务</li>
                <li>使用 SOFABoot + SOFARPC 调用服务</li>
                <li>通过 ZipKin 查看 SOFATracer 上报的 Tracer 信息</li>
                <li>通过 SOFALookout 查看上报的 Metrics 信息</li>
            </ul>

            <h2 id="架构图">架构图</h2>

            <p><img src="img/765a9259d8cd4a428b6f8160c8591f9c.gif" alt="pic" /></p>

            <h2 id="任务">任务</h2>

            <h4 id="1-任务准备">1、任务准备</h4>

            <p>从  github 上将 demo 工程克隆到本地</p>

            <pre><code class="language-bash">git clone https://github.com/sofastack-guides/kc-sofastack-demo.git
</code></pre>

            <p>然后将工程导入到 IDEA 或者 eclipse。导入之后界面如下：</p>

            <p><img src="img/3101cf970ba942068c92ffb0e6205096.gif" alt="pic" /></p>

            <ul>
                <li>balance-mng：余额管理系统，提供扣减余额服务</li>
                <li>stock-mng：库存管理系统，提供扣减库存服务</li>
            </ul>

            <h4 id="2-引入依赖">2、引入依赖</h4>

            <p>将下面的依赖引入到 balance-mng 和 stock-mng 工程模块的 pom.xml 文件中。</p>

            <pre><code class="language-xml">&lt;!--SOFARPC 依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;rpc-sofa-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--SOFATracer 依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;tracer-sofa-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--SOFARegistry 依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;registry-client-all&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--runtime 依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;runtime-sofa-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--SOFALookout 依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa.lookout&lt;/groupId&gt;
    &lt;artifactId&gt;lookout-sofa-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>

            <p>balance-mng 工程需要将依赖引入 balance-mng/balance-mng-impl/pom.xml 文件：</p>

            <p><img src="img/232578f21bc949d982b42b2f6d173754.gif" alt="pic" /></p>

            <p>stock-mng 工程直接将依赖引入 stock-mng/pom.xml 文件：</p>

            <p><img src="img/34fbcda575754aa48e7eb7b95a244c8e.gif" alt="pic" /></p>

            <h4 id="3-添加配置">3、添加配置</h4>

            <p>将如下配置复制到 balance-mng 和 stock-mng 工程模块的 application.properties 中。</p>

            <pre><code class="language-properties"># 1、添加服务注册中心地址
com.alipay.sofa.rpc.registry.address=sofa://118.31.43.62:9603
# 2、添加 tracer 数据上报的服务端 zipkin 地址
com.alipay.sofa.tracer.zipkin.base-url=http://116.62.131.134:9411
# 3、添加 metrics 数据上报的服务端地址
com.alipay.sofa.lookout.agent-host-address=121.43.187.56
</code></pre>

            <p>balance-mng 工程需要将配置添加至 balance-mng/balance-mng-bootstrap/src/main/resources/application.properties 文件：</p>

            <p><img src="img/c491bf9c6e8f452ca2f8d2386c1e5f49.gif" alt="pic" /></p>

            <p>stock-mng 工程需要将配置添加至 stock-mng/src/main/resources/application.properties 文件：</p>

            <p><img src="img/d884eaa91a0d47bcba6aab3cba72ad2f.gif" alt="pic" /></p>

            <h4 id="4-修改-unique-id">4、修改 unique id</h4>

            <p>由于所有人共用一套服务发现，为区分不同用户发布的服务，需要为服务增加 unique id。</p>

            <p>KubeCon workshop 会给每个用户准备一个 SOFAStack 账号，格式为 user0@sofastack.io 到 user99@sofastack.io，去掉 @sofastack.io 部分，账户前半部分的 user0 至 user99 即可作为 unique id。</p>

            <p>balance-mng 工程需要在 balance-mng/balance-mng-bootstrap/src/main/resources/application.properties 文件修改：</p>

            <p><img src="img/16720034023d4464b7b2749a17d9ce8f.gif" alt="pic" /></p>

            <p>stock-mng 工程需要在 stock-mng/src/main/resources/application.properties 文件修改：</p>

            <p><img src="img/622e3c3973f148d1be317e30124374c2.gif" alt="pic" /></p>

            <h4 id="5-发布-sofarpc-服务">5、发布 SOFARPC 服务</h4>

            <p>在 BalanceMngImpl 类上加上 @SofaService 注解 和 @Service 注解，将其发布成一个 SOFARPC 服务：</p>

            <pre><code class="language-java">import org.springframework.stereotype.Service;
import com.alipay.sofa.runtime.api.annotation.SofaService;
import com.alipay.sofa.runtime.api.annotation.SofaServiceBinding;

@Service
@SofaService(interfaceType = BalanceMngFacade.class, uniqueId = &quot;${service.unique.id}&quot;, bindings = { @SofaServiceBinding(bindingType = &quot;bolt&quot;) })
</code></pre>

            <p>增加之后的 BalanceMngImpl 类如下图所示：</p>

            <p><img src="img/030aa71013454b3b9065a8ec67b30cdb.gif" alt="pic" /></p>

            <p>在 StockMngImpl 类上加上 @SofaService 注解 和 @Service 注解，将其发布成一个 SOFARPC 服务：</p>

            <pre><code class="language-java">import org.springframework.stereotype.Service;
import com.alipay.sofa.runtime.api.annotation.SofaService;
import com.alipay.sofa.runtime.api.annotation.SofaServiceBinding;

@Service
@SofaService(interfaceType = StockMngFacade.class, uniqueId = &quot;${service.unique.id}&quot;, bindings = { @SofaServiceBinding(bindingType = &quot;bolt&quot;) })
</code></pre>

            <p>增加之后的 StockMngImpl 类如下图所示：</p>

            <p><img src="img/92b930a1192440e7b981388cabe0ca96.gif" alt="pic" /></p>

            <h4 id="6-引用-sofarpc-服务">6、引用 SOFARPC 服务</h4>

            <p>在 BookStoreControllerImpl 类中的 stockMngFacade 变量上方加 @SofaReference 注解，用于引用 SOFARPC 服务:</p>

            <pre><code class="language-java">import com.alipay.sofa.runtime.api.annotation.SofaReference;
import com.alipay.sofa.runtime.api.annotation.SofaReferenceBinding;

@SofaReference(interfaceType = StockMngFacade.class, uniqueId = &quot;${service.unique.id}&quot;, binding = @SofaReferenceBinding(bindingType = &quot;bolt&quot;))
</code></pre>

            <p>在 BookStoreControllerImpl 类中的 balanceMngFacade 变量上方加 @SofaReference 注解，用于引用 SOFARPC 服务:</p>

            <pre><code class="language-java">import com.alipay.sofa.runtime.api.annotation.SofaReference;
import com.alipay.sofa.runtime.api.annotation.SofaReferenceBinding;

@SofaReference(interfaceType = BalanceMngFacade.class, uniqueId = &quot;${service.unique.id}&quot;, binding = @SofaReferenceBinding(bindingType = &quot;bolt&quot;))
</code></pre>

            <p>增加之后的 BookStoreControllerImpl 类如下图所示：</p>

            <p><img src="img/7a179446d84f4c5dacb8f8454299553f.gif" alt="pic" /></p>

            <h4 id="7-实验验证">7、实验验证</h4>

            <p>运行 BalanceMngApplication 和 StockMngApplication 即可启动应用。应用启动之后，通过浏览器访问：<a href="http://localhost:8080">http://localhost:8080</a> 即可正常操作页面:</p>

            <p><img src="img/4d4080fe80a84c84bb99871fa14fb19b.gif" alt="pic" /></p>

            <p>浏览器访问 <a href="http://116.62.131.134:9411">http://116.62.131.134:9411</a>，查看链路数据上报以链路关系图：</p>

            <p><img src="img/0039b391c0e0412793234d59e624c59c.gif" alt="pic" /></p>

            <p>浏览器访问 <a href="http://121.43.187.56:9090">http://121.43.187.56:9090</a> 即可查看上报 metrics：</p>

            <p><img src="img/6a59d50679fc46e68130432b068140c8.gif" alt="pic" /></p>

            <ul>
                <li><code>jvm.threads.totalStarted{app=&quot;stock_mng&quot;}</code>：可以查看 JVM 启动线程数</li>
                <li><code>rpc.consumer.service.stats.total_count.count{app=&quot;stock_mng&quot;}</code>：可以查看 stock_mng 应用的调用次数</li>
            </ul>

            <p>关于 SOFALookout 的更多用法，请参考: <a href="https://www.sofastack.tech/sofa-lookout/docs/Home">https://www.sofastack.tech/sofa-lookout/docs/Home</a></p>

            <h2 id="更多">更多</h2>

            <ul>
                <li><a href="https://gw.alipayobjects.com/os/basement_prod/b16fd217-b82b-436e-8b0d-452e636e072b.pdf">下载本次 Demo 幻灯片</a>。</li>
            </ul>

        </article>


        <nav class="ss-pagination-next">
            <a class="link-prev" href="/guides/kc-seata-demo/">
                <span class="text">上一篇: </span>
                <span class="text">使用 Seata 保障支付一致性</span>
            </a>
            <a class="link-next" href="/guides/kc-cloud-mesh-demo/">
                <span class="text">下一篇: </span>
                <span class="text">使用 CloudMesh 轻松实践 Service Mesh</span>
            </a>
        </nav>
        <div class="chat-box">
            <div id="gitalk-container"></div>
        </div>
    </main>

    <aside class="ss-layout-aside">
        <div class="ss-card">
            <h2 class="card-title">
                获取代码
            </h2>
            <div id="js-code" class="ss-aside-code">
                <div class="button-group">
                    <button class="button">HTTPS</button>
                    <button class="button">SSH</button>
                </div>
                <div class="input-group">
                    <input class="input" value="https://github.com/sofastack-guides/kc-sofastack-demo" spellcheck="false" />
                    <span class="addon">
				<svg class="icon copy" aria-hidden="true"><use xlink:href="#icon-copy"></use></svg>
				<svg class="icon tick" aria-hidden="true"><use xlink:href="#icon-ictick"></use></svg>
			</span>
                </div>
                <a class="button download"
                   href="https://github.com/sofastack-guides/kc-sofastack-demo/archive/master.zip"> 下载 ZIP</a>
            </div>
        </div>
        <div class="ss-card ss-aside-toc">
            <h2 class="card-title">
                目录
            </h2>
            <nav id="TableOfContents">
                <ul>
                    <li><a href="#实验内容">实验内容</a></li>
                    <li><a href="#架构图">架构图</a></li>
                    <li><a href="#任务">任务</a>
                        <ul>
                            <li>
                                <ul>
                                    <li><a href="#1-任务准备">1、任务准备</a></li>
                                    <li><a href="#2-引入依赖">2、引入依赖</a></li>
                                    <li><a href="#3-添加配置">3、添加配置</a></li>
                                    <li><a href="#4-修改-unique-id">4、修改 unique id</a></li>
                                    <li><a href="#5-发布-sofarpc-服务">5、发布 SOFARPC 服务</a></li>
                                    <li><a href="#6-引用-sofarpc-服务">6、引用 SOFARPC 服务</a></li>
                                    <li><a href="#7-实验验证">7、实验验证</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li><a href="#更多">更多</a></li>
                </ul>
            </nav>
        </div>
        <div class="ss-card">
            <h2 class="card-title">
                章节
            </h2>
            <div class="ss-aside-project">
                <a class="link" href="https://github.com/sofastack/sofa-boot">SOFABoot</a>
                <a class="link" href="https://github.com/sofastack/sofa-rpc">SOFARPC</a>
                <a class="link" href="https://github.com/sofastack/sofa-lookout">SOFALookout</a>
            </div>
        </div>
    </aside>
</div>
<footer class="ss-footer">
    <div class="container">
        <div class="links">
            <div class="cate">
                <h2 class="cate-title">资源</h2>
                <a class="link" href="https://github.com/ramostear">Github</a>
                <a class="link" href="https://gitee.com/ramostear">Gitee</a>
            </div>
            <div class="cate">
                <h2 class="cate-title">社交媒体</h2>
                <a class="link" href="https://zhuanlan.zhihu.com/sofastack">知乎专栏</a>
                <a class="link" href="https://weibo.com/ramostear">新浪微博</a>
                <a class="link" href="#">今日头条</a>
            </div>
            <div class="cate">
                <h2 class="cate-title">友情链接</h2>

                <a class="link" href="https://ant.design/">Ant Design</a>

                <a class="link" href="https://eggjs.org/">Egg </a>

                <a class="link" href="https://sqlflow.org">SQLFlow</a>

                <a class="link" href="https://tech.antfin.com/open-source">更多</a>

            </div>

        </div>
        <div class="qrcode">
            <div>
                <img class="qrcode-img" src="image/qrcode_1.png"/>
                <p class="qrcode-desc">微信号</p>
            </div>
            <div>
                <img class="qrcode-img" src="image/qrcode_2.png"/>
                <p class="qrcode-desc">QQ群</p>
            </div>
        </div>
    </div>
    <div class="copyright">
        <p>
            © 2019 ramostear
            <a href="http://icp.chinaz.com/info?q=ramostear.com">黔ICP备15000250号-1 </a>
            <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=52230102000133">贵公网安备 52230102000133号</a>
        </p>
    </div>
</footer>
<script src="https://cdn.bootcss.com/gitalk/1.5.0/gitalk.js"></script>
<script src="js/md5.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '0a82ed88ad9840a165e9',
        clientSecret: '70d22da14bd958ceb8691689745f13ccab77abe0',
        repo: 'gitalk-repo',
        owner: 'ramostear@163.com',
        admin: "ramostear@163.com",
        id: md5(location.pathname),
    });
    gitalk.render("gitalk-container");
</script>
</body>

</html>